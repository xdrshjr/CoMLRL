{{/* Inject KaTeX globally when math is enabled at site or page level */}}
{{- $enableMath := or (default false .Site.Params.BookMath) (default false .Params.math) -}}
{{- if and $enableMath (not (.Page.Store.Get "katex")) -}}
  <link rel="stylesheet" href="{{ "katex/katex.min.css" | relURL }}" />
  <script defer src="{{ "katex/katex.min.js" | relURL }}"></script>
  {{ with resources.Get "katex.json" }}
    <script defer src="{{ "katex/auto-render.min.js" | relURL }}" onload="renderMathInElement(document.body, {{ .Content | safeJS }});"></script>
  {{ end }}
  {{- .Page.Store.Set "katex" true -}}
{{- end -}}

{{/* Custom sidebar style overrides for menu colors */}}
<link rel="stylesheet" href="{{ "css/sidebar.css" | relURL }}" />

{{/* Override default favicon with CoMLRL icon */}}
<link rel="icon" type="image/svg+xml" href="{{ "img/comlrl-icon.svg" | relURL }}" />
<link rel="icon" type="image/png" href="{{ "img/comlrl-icon.png" | relURL }}" />
<link rel="shortcut icon" type="image/png" href="{{ "img/comlrl-icon.png" | relURL }}" />
<link rel="apple-touch-icon" href="{{ "img/comlrl-icon.png" | relURL }}" />

{{/* Inject H1 title at top of each article using the header title */}}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    try {
      var article = document.querySelector('article.book-article');
      if (!article) return;
      var headerTitleEl = document.querySelector('.book-header h3');
      var title = headerTitleEl ? headerTitleEl.textContent.trim() : (document.title || '').split('|')[0].trim();
      if (!title) return;
      var firstH1 = article.querySelector('h1');
      if (!firstH1 || firstH1.textContent.trim() !== title) {
        var h1 = document.createElement('h1');
        h1.textContent = title;
        article.insertBefore(h1, article.firstChild);
      }

      // Inject floating copyright footer once per page (single bold phrase)
      (function() {
        var footer = document.getElementById('omlrl-footer');
        if (!footer) {
          footer = document.createElement('div');
          footer.id = 'omlrl-footer';
          footer.className = 'omlrl-footer';
          document.body.appendChild(footer);
        }
        // Render as one bold phrase to keep spacing consistent
        footer.textContent = '';
        var all = document.createElement('strong');
        all.textContent = '\u00A9 OpenMLRL. All rights reserved.';
        footer.appendChild(all);
      })();
    } catch (e) {
      /* no-op */
    }
  });

  // Cmd+K / Ctrl+K shortcut for search, Cmd/Ctrl+O for OpenMLRL, Cmd/Ctrl+L for LovelyBuggies
  document.addEventListener('keydown', function(e) {
    if (!(e.metaKey || e.ctrlKey)) return;
    var key = (e.key || '').toLowerCase();
    if (key === 'k') {
      e.preventDefault();
      var searchInput = document.querySelector('.book-search input');
      if (searchInput) {
        searchInput.focus();
      }
      return;
    }
    if (key === 'o') {
      e.preventDefault();
      window.location.href = 'https://openmlrl.github.io';
      return;
    }
    if (key === 'l') {
      e.preventDefault();
      window.location.href = 'https://lovelybuggies.github.io';
    }
  });

  // Add copy buttons to code blocks
  document.addEventListener('DOMContentLoaded', function() {
    var codeBlocks = document.querySelectorAll('pre');
    codeBlocks.forEach(function(codeBlock) {
      var button = document.createElement('button');
      button.className = 'copy-code-button';
      button.textContent = 'Copy';
      button.addEventListener('click', function() {
        var code = codeBlock.querySelector('code');
        var text = code.textContent;
        navigator.clipboard.writeText(text).then(function() {
          button.textContent = 'Copied!';
          setTimeout(function() {
            button.textContent = 'Copy';
          }, 2000);
        });
      });
      codeBlock.style.position = 'relative';
      codeBlock.appendChild(button);
    });
  });
  </script>
