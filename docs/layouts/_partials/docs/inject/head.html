{{/* Inject KaTeX globally when math is enabled at site or page level */}}
{{- $enableMath := or (default false .Site.Params.BookMath) (default false .Params.math) -}}
{{- if and $enableMath (not (.Page.Store.Get "katex")) -}}
  <link rel="stylesheet" href="{{ "katex/katex.min.css" | relURL }}" />
  <script defer src="{{ "katex/katex.min.js" | relURL }}"></script>
  {{ with resources.Get "katex.json" }}
    <script defer src="{{ "katex/auto-render.min.js" | relURL }}" onload="renderMathInElement(document.body, {{ .Content | safeJS }});"></script>
  {{ end }}
  {{- .Page.Store.Set "katex" true -}}
{{- end -}}

{{/* Custom sidebar style overrides for menu colors */}}
<link rel="stylesheet" href="{{ "css/sidebar.css" | relURL }}" />

{{/* Override default favicon with CoMLRL icon */}}
<link rel="icon" type="image/svg+xml" href="{{ "img/comlrl-icon.svg" | relURL }}" />
<link rel="icon" type="image/png" href="{{ "img/comlrl-icon.png" | relURL }}" />
<link rel="shortcut icon" type="image/png" href="{{ "img/comlrl-icon.png" | relURL }}" />
<link rel="apple-touch-icon" href="{{ "img/comlrl-icon.png" | relURL }}" />

{{/* Inject H1 title at top of each article using the header title */}}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    try {
      var article = document.querySelector('article.book-article');
      if (!article) return;
      var headerTitleEl = document.querySelector('.book-header h3');
      var title = headerTitleEl ? headerTitleEl.textContent.trim() : (document.title || '').split('|')[0].trim();
      if (!title) return;
      var firstH1 = article.querySelector('h1');
      if (!firstH1 || firstH1.textContent.trim() !== title) {
        var h1 = document.createElement('h1');
        h1.textContent = title;
        article.insertBefore(h1, article.firstChild);
      }

      // Inject floating copyright footer once per page (single bold phrase)
      (function() {
        var footer = document.getElementById('omlrl-footer');
        if (!footer) {
          footer = document.createElement('div');
          footer.id = 'omlrl-footer';
          footer.className = 'omlrl-footer';
          document.body.appendChild(footer);
        }
        // Render as one bold phrase to keep spacing consistent
        footer.textContent = '';
        var all = document.createElement('strong');
        all.textContent = '\u00A9 OpenMLRL. All rights reserved.';
        footer.appendChild(all);
      })();
    } catch (e) {
      /* no-op */
    }
  });

  // Cmd+K / Ctrl+K shortcut for search, Cmd/Ctrl+O for OpenMLRL, Cmd/Ctrl+G for GitHub
  document.addEventListener('keydown', function(e) {
    if (!(e.metaKey || e.ctrlKey)) return;
    var key = (e.key || '').toLowerCase();
    if (key === 'k') {
      e.preventDefault();
      var searchInput = document.querySelector('.book-search input');
      if (searchInput) {
        searchInput.focus();
      }
      return;
    }
    if (key === 'o') {
      e.preventDefault();
      window.location.href = 'https://openmlrl.github.io';
      return;
    }
    if (key === 'g') {
      e.preventDefault();
      window.location.href = 'https://github.com/OpenMLRL/CoMLRL';
      return;
    }
  });

  // Add copy buttons to code blocks
  document.addEventListener('DOMContentLoaded', function() {
    var codeBlocks = document.querySelectorAll('pre');
    codeBlocks.forEach(function(codeBlock) {
      var button = document.createElement('button');
      button.className = 'copy-code-button';
      button.textContent = 'Copy';
      button.addEventListener('click', function() {
        var code = codeBlock.querySelector('code');
        var text = code.textContent;
        navigator.clipboard.writeText(text).then(function() {
          button.textContent = 'Copied!';
          setTimeout(function() {
            button.textContent = 'Copy';
          }, 2000);
        });
      });
      codeBlock.style.position = 'relative';
      codeBlock.appendChild(button);
    });

    // Add GitHub corner ribbon
    var githubCorner = document.createElement('a');
    githubCorner.href = 'https://github.com/OpenMLRL/CoMLRL';
    githubCorner.className = 'github-corner';
    githubCorner.target = '_blank';
    githubCorner.rel = 'noopener noreferrer';
    githubCorner.setAttribute('aria-label', 'View source on GitHub');
    githubCorner.innerHTML = '<svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><defs><linearGradient id="github-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#9555af;stop-opacity:1" /><stop offset="100%" style="stop-color:#e091c4;stop-opacity:1" /></linearGradient></defs><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" fill="url(#github-gradient)"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="#fff" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="#fff" class="octo-body"></path></svg>';
    document.body.appendChild(githubCorner);
  });
  </script>
